<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KRATOS // ENTERPRISE GRID</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

    <style>
        /* =========================================
           CORE VISUALS
           ========================================= */
        :root {
            --primary: #00ffcc;
            --bg: #050505;
            --glass: rgba(0, 15, 10, 0.85); /* Darker for mobile readability */
            --border: 1px solid rgba(0, 255, 204, 0.4);
        }

        body {
            margin: 0;
            overflow: hidden; /* Desktop: Hidden */
            background: #000;
            font-family: 'Consolas', 'Monaco', monospace;
            color: var(--primary);
            -webkit-tap-highlight-color: transparent; /* Remove mobile tap gray box */
        }

        #world, #scanlines, #vignette {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        }
        #world { z-index: 0; }
        #scanlines { 
            z-index: 999; pointer-events: none; 
            background: linear-gradient(rgba(0,0,0,0) 50%, rgba(0,0,0,0.1) 50%); 
            background-size: 100% 4px; opacity: 0.6; 
        }
        #vignette { 
            z-index: 998; pointer-events: none; 
            background: radial-gradient(circle, transparent 50%, black 120%); 
        }

        /* =========================================
           BOOT SCREEN
           ========================================= */
        #boot-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2000; padding: 20px;
            display: flex; flex-direction: column; justify-content: center;
        }
        .boot-line { font-size: 14px; margin-bottom: 5px; opacity: 0; color: var(--primary); }

        /* =========================================
           UI LAYER & WINDOWS
           ========================================= */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100;
            pointer-events: none; /* Let clicks pass through to 3D BG if needed */
        }

        .window {
            position: absolute; /* Default: Floating */
            background: var(--glass);
            border: var(--border);
            backdrop-filter: blur(12px);
            box-shadow: 0 0 20px rgba(0, 255, 204, 0.1);
            display: flex; flex-direction: column;
            pointer-events: auto; /* Enable clicks on windows */
            border-radius: 4px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .window-header {
            background: rgba(0, 50, 40, 0.9);
            padding: 10px;
            font-size: 11px; letter-spacing: 1px; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: var(--border);
            cursor: grab; /* Desktop hint */
        }
        
        .controls span {
            display: inline-block; width: 8px; height: 8px; 
            border-radius: 50%; margin-left: 5px; 
        }
        .close { background: #ff4444; } .min { background: #ffcc00; }

        .window-content { padding: 15px; color: #ccffee; font-size: 12px; }

        /* DESKTOP DEFAULT POSITIONS */
        #win-miner { top: 15%; left: 10%; width: 380px; }
        #win-stats { top: 15%; right: 10%; width: 320px; }
        #win-log { bottom: 5%; left: 10%; width: 500px; height: 150px; }

        /* COMPONENTS */
        button.cyber-btn {
            background: rgba(0, 20, 10, 0.5);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 15px; width: 100%;
            font-family: inherit; font-weight: bold; font-size: 14px;
            cursor: pointer; transition: 0.2s; margin-top: 10px;
            text-transform: uppercase;
        }
        button.cyber-btn:active { background: var(--primary); color: #000; }
        button.cyber-btn:disabled { border-color: #555; color: #555; }

        .progress-container { width: 100%; height: 6px; background: #111; margin-top: 10px; border: 1px solid #333; }
        .progress-bar { width: 0%; height: 100%; background: var(--primary); box-shadow: 0 0 10px var(--primary); transition: width 0.1s; }

        canvas.chart { width: 100%; height: 80px; background: rgba(0,0,0,0.3); border: 1px solid #004433; margin-top: 5px; }

        /* =========================================
           RESPONSIVE MOBILE OVERRIDES
           ========================================= */
        @media (max-width: 768px) {
            body { overflow-y: auto; /* Allow scroll on mobile */ }
            
            #ui-layer {
                position: relative; /* Switch to flow layout */
                height: auto;
                padding: 10px;
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
                gap: 15px; /* Space between windows */
                padding-bottom: 50px;
            }

            .window {
                position: relative !important; /* Force stack */
                top: auto !important; left: auto !important; right: auto !important; bottom: auto !important;
                width: 100% !important; /* Full width */
                height: auto !important;
                margin-bottom: 0;
            }

            .window-header { cursor: default; } /* No dragging on mobile */
            
            #win-miner { order: 1; } /* Order of appearance */
            #win-stats { order: 2; }
            #win-log { order: 3; height: 200px !important; }
            
            h1#hash-big { font-size: 42px !important; } /* Bigger text for touch */
            .boot-line { font-size: 12px; }
        }
    </style>
</head>
<body>

    <div id="boot-screen"></div>
    <div id="world"></div>
    <div id="scanlines"></div>
    <div id="vignette"></div>

    <div id="ui-layer" style="display: none;">
        
        <div id="win-miner" class="window">
            <div class="window-header">
                <span>KRATOS_NODE_v4.2.exe</span>
                <div class="controls"><span class="min"></span><span class="close"></span></div>
            </div>
            <div class="window-content">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span>STATUS</span><span id="conn-status" style="color:red">OFFLINE</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                    <span>GPU</span><span id="gpu-status">DETECTING...</span>
                </div>

                <div style="text-align: center; border: 1px solid #004433; padding: 20px; background: rgba(0,0,0,0.3);">
                    <h1 id="hash-big" style="margin:0; font-size: 32px; text-shadow: 0 0 10px var(--primary);">0.00</h1>
                    <small style="color:#88ffcc; letter-spacing: 2px;">MH/s</small>
                </div>

                <div class="progress-container">
                    <div id="progress-bar" class="progress-bar"></div>
                </div>
                <div style="text-align: right; font-size: 10px; margin-top: 4px; color: #888;" id="batch-id">BATCH: WAITING</div>

                <button id="btn-init" class="cyber-btn" onclick="initSystem()">CONNECT TO GRID</button>
                <button id="btn-req" class="cyber-btn" disabled onclick="requestBatch()">START MINING</button>
            </div>
        </div>

        <div id="win-stats" class="window">
            <div class="window-header"><span>SYSTEM_TELEMETRY</span><div class="controls"><span class="min"></span></div></div>
            <div class="window-content">
                <div style="font-size:10px; color:#aaa; margin-bottom:2px;">GPU LOAD</div>
                <canvas id="chart-load" class="chart"></canvas>
                <div style="font-size:10px; color:#aaa; margin-top:10px; margin-bottom:2px;">MEMORY USAGE</div>
                <canvas id="chart-mem" class="chart"></canvas>
            </div>
        </div>

        <div id="win-log" class="window">
            <div class="window-header"><span>CONSOLE_OUT</span><div class="controls"><span class="min"></span></div></div>
            <div class="window-content" id="log-feed" style="height:100%; overflow-y:auto; font-family:'Courier New'; line-height:1.4;">
                <span style="color:#0f0">> SYSTEM READY.</span><br>
            </div>
        </div>
    </div>

    <script>
        /* =====================
           AUDIO ENGINE
           ===================== */
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function sfx(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime;
            if (type === 'boot') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(50, now);
                osc.frequency.linearRampToValueAtTime(800, now + 1);
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.1, now + 0.5);
                gain.gain.linearRampToValueAtTime(0, now + 2);
                osc.start(); osc.stop(now + 2);
            } else if (type === 'click') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start(); osc.stop(now + 0.1);
            }
        }

        /* =====================
           BOOT SEQUENCE
           ===================== */
        window.onload = async () => {
            const lines = [
                "KRATOS KERNEL v5.0 loading...",
                "Mounting File System... OK",
                "Checking WebGPU Support... FOUND",
                "Initializing Neural Interface... DONE",
                "WELCOME COMMANDER."
            ];
            const screen = document.getElementById('boot-screen');
            
            // Try to play sound (might be blocked on mobile until tap, handled gracefully)
            try { sfx('boot'); } catch(e){}

            for(let line of lines) {
                const div = document.createElement('div');
                div.className = 'boot-line';
                div.innerText = line;
                screen.appendChild(div);
                await new Promise(r => setTimeout(r, 200));
                div.style.opacity = 1;
            }
            await new Promise(r => setTimeout(r, 800));
            screen.style.opacity = 0;
            setTimeout(() => {
                screen.style.display = 'none';
                document.getElementById('ui-layer').style.display = window.innerWidth > 768 ? 'block' : 'flex'; // Block for desktop, Flex for mobile
                init3D();
            }, 1000);
        };

        /* =====================
           3D BACKGROUND
           ===================== */
        function init3D() {
            const container = document.getElementById('world');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.z = 25;
            
            const renderer = new THREE.WebGLRenderer({alpha:true, antialias:true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);

            // Globe
            const geo = new THREE.IcosahedronGeometry(10, 2);
            const mat = new THREE.MeshBasicMaterial({color: 0x00ffcc, wireframe: true, transparent: true, opacity: 0.15});
            const globe = new THREE.Mesh(geo, mat);
            scene.add(globe);

            // Particles
            const pGeo = new THREE.BufferGeometry();
            const pCount = 600;
            const pPos = new Float32Array(pCount*3);
            for(let i=0; i<pCount*3; i++) pPos[i] = (Math.random()-0.5)*70;
            pGeo.setAttribute('position', new THREE.BufferAttribute(pPos, 3));
            const pMat = new THREE.PointsMaterial({size:0.1, color:0x00ffcc});
            const particles = new THREE.Points(pGeo, pMat);
            scene.add(particles);

            function animate() {
                requestAnimationFrame(animate);
                globe.rotation.y += 0.001;
                particles.rotation.y -= 0.0005;
                renderer.render(scene, camera);
            }
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth/window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                // Fix UI layout on resize
                if(window.innerWidth > 768) document.getElementById('ui-layer').style.display = 'block';
                else document.getElementById('ui-layer').style.display = 'flex';
            });
        }

        /* =====================
           DRAGGABLE WINDOWS (Desktop Only)
           ===================== */
        if (window.innerWidth > 768) {
            document.querySelectorAll('.window-header').forEach(hdr => {
                hdr.addEventListener('mousedown', e => {
                    const win = hdr.parentElement;
                    const shiftX = e.clientX - win.getBoundingClientRect().left;
                    const shiftY = e.clientY - win.getBoundingClientRect().top;
                    
                    // Z-Index Management
                    document.querySelectorAll('.window').forEach(w => w.style.zIndex = 10);
                    win.style.zIndex = 100;

                    function moveAt(px, py) {
                        win.style.left = px - shiftX + 'px';
                        win.style.top = py - shiftY + 'px';
                    }
                    function onMove(ev) { moveAt(ev.pageX, ev.pageY); }
                    
                    document.addEventListener('mousemove', onMove);
                    win.onmouseup = () => {
                        document.removeEventListener('mousemove', onMove);
                        win.onmouseup = null;
                    };
                });
            });
        }

        /* =====================
           MINING LOGIC
           ===================== */
        const logBox = document.getElementById('log-feed');
        function log(msg, type="INFO") {
            const col = type=="ERR"?"red":(type=="SUCCESS"?"lime":"#00ccff");
            logBox.innerHTML += `<div><span style="color:#666">[${new Date().toLocaleTimeString('en-GB')}]</span> <span style="color:${col}">${type}</span> ${msg}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        let isConn = false;
        let serverRange = 0;

        function initSystem() {
            sfx('click');
            const btn = document.getElementById('btn-init');
            btn.disabled = true;
            btn.innerText = "HANDSHAKE...";
            document.getElementById('conn-status').innerText = "CONNECTING";
            document.getElementById('conn-status').style.color = "yellow";
            
            setTimeout(() => {
                isConn = true;
                btn.style.display = "none";
                document.getElementById('btn-req').disabled = false;
                document.getElementById('conn-status').innerText = "ONLINE";
                document.getElementById('conn-status').style.color = "lime";
                
                if(navigator.gpu) {
                    document.getElementById('gpu-status').innerText = "READY";
                    document.getElementById('gpu-status').style.color = "lime";
                    log("WebGPU Adapter Mounted.", "SYS");
                } else {
                    document.getElementById('gpu-status').innerText = "MISSING";
                    document.getElementById('gpu-status').style.color = "red";
                    log("WebGPU Not Found. Mode: Simulation.", "WARN");
                }
            }, 1000);
        }

        async function requestBatch() {
            if(!isConn) return;
            sfx('click');
            const btn = document.getElementById('btn-req');
            const bar = document.getElementById('progress-bar');
            
            btn.disabled = true;
            btn.innerText = "MINING...";
            
            // SIMULATE SERVER FETCH
            log("Requesting Batch...", "NET");
            await new Promise(r => setTimeout(r, 500));
            const rangeStart = serverRange;
            const rangeEnd = serverRange + 1000000;
            serverRange += 1000000;
            
            document.getElementById('batch-id').innerText = `BATCH: ${rangeStart}-${rangeEnd}`;
            log(`Received Job: ${rangeStart}`, "JOB");

            // EXECUTE (WebGPU)
            try {
                if(!navigator.gpu) throw new Error("No GPU");
                const adapter = await navigator.gpu.requestAdapter();
                const device = await adapter.requestDevice();
                
                // Shader
                const shader = `
                    @group(0) @binding(0) var<storage, read_write> out: array<u32>;
                    @group(0) @binding(1) var<storage, read_write> p: array<u32>;
                    fn hash(k:u32)->u32{var h=k;h^=h>>16;h*=0x85ebca6bu;h^=h>>13;h*=0xc2b2ae35u;h^=h>>16;return h;}
                    @compute @workgroup_size(64) fn main(@builtin(global_invocation_id) id:vec3<u32>){
                        let x=id.x+p[0]; if((hash(x)%10000u)==7777u){out[0]=1u;out[1]=x;}
                    }
                `;
                
                // Buffers
                const gpuBuf = device.createBuffer({size:12, usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST});
                const readBuf = device.createBuffer({size:12, usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST});
                const paramBuf = device.createBuffer({size:4, usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});
                device.queue.writeBuffer(paramBuf, 0, new Uint32Array([rangeStart]));

                const module = device.createShaderModule({code:shader});
                const pipe = device.createComputePipeline({layout:'auto', compute:{module, entryPoint:'main'}});
                const group = device.createBindGroup({layout:pipe.getBindGroupLayout(0), entries:[{binding:0, resource:{buffer:gpuBuf}},{binding:1, resource:{buffer:paramBuf}}]});

                const t0 = performance.now();
                const enc = device.createCommandEncoder();
                const pass = enc.beginComputePass();
                pass.setPipeline(pipe); pass.setBindGroup(0, group);
                pass.dispatchWorkgroups(Math.ceil(1000000/64)); pass.end();
                enc.copyBufferToBuffer(gpuBuf, 0, readBuf, 0, 12);
                device.queue.submit([enc.finish()]);

                // Fake Progress Bar Animation while GPU works
                bar.style.width = "50%";
                
                await readBuf.mapAsync(GPUMapMode.READ);
                const res = new Uint32Array(readBuf.getMappedRange());
                const t1 = performance.now();
                bar.style.width = "100%";

                const mhs = (1 / ((t1-t0)/1000)).toFixed(2);
                document.getElementById('hash-big').innerText = mhs;

                if(res[0]===1) {
                    log(`>>> GOLDEN NONCE: ${res[1]} <<<`, "SUCCESS");
                    btn.innerText = "SUBMIT & NEXT";
                } else {
                    log("Batch Clear.", "INFO");
                    btn.innerText = "NEXT BATCH";
                }
                readBuf.unmap();

            } catch(e) {
                // Fallback for non-GPU devices (Simulation)
                log("GPU Error / Fallback: " + e.message, "WARN");
                await new Promise(r => setTimeout(r, 1000));
                bar.style.width = "100%";
                document.getElementById('hash-big').innerText = (Math.random()*10+5).toFixed(2);
                log("Batch Clear (Simulated).", "INFO");
                btn.innerText = "NEXT BATCH";
            }
            
            btn.disabled = false;
        }

        /* =====================
           CHARTS
           ===================== */
        function drawChart(id) {
            const cvs = document.getElementById(id);
            const ctx = cvs.getContext('2d');
            let data = new Array(30).fill(0);
            
            function loop() {
                cvs.width = cvs.parentElement.offsetWidth - 30; // Responsive width
                cvs.height = 80;
                
                data.push(Math.random() * (isConn?50:5));
                data.shift();
                
                ctx.clearRect(0,0,cvs.width,cvs.height);
                ctx.beginPath();
                ctx.strokeStyle = "#00ffcc";
                ctx.lineWidth = 1.5;
                for(let i=0; i<data.length; i++) {
                    const x = (i/(data.length-1)) * cvs.width;
                    const y = cvs.height - (data[i]/100)*cvs.height;
                    if(i==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                }
                ctx.stroke();
                requestAnimationFrame(loop);
            }
            loop();
        }
        drawChart('chart-load');
        drawChart('chart-mem');

    </script>
</body>
</html>
